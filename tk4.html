<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¨ã—æ´»ç´€éŒ„</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root { --main-pink: #ffb7b2; --soft-bg: #fdf6f0; }
    body { 
        background-color: var(--soft-bg); 
        font-family: 'Kiwi Maru', 'Noto Sans TC', sans-serif;
        color: #5d514a; 
        letter-spacing: 0.02em; 
    }
    h1 { font-family: 'Kiwi Maru', serif !important; font-weight: 500; }
    .soft-card { background: white; border-radius: 24px; box-shadow: 0 8px 20px rgba(180, 160, 140, 0.08); border: 1px solid rgba(255, 255, 255, 0.5); }
    .btn-main { background: var(--main-pink); color: white; border-radius: 16px; transition: all 0.2s ease; }
    .chat-bubble { max-width: 85%; width: fit-content; padding: 10px 16px; margin-bottom: 4px; font-size: 14px; line-height: 1.6; border-radius: 18px; position: relative; font-weight: 500; }
    .bubble-me { background: #ffdbcc; color: #7c4d3a; align-self: flex-end; border-radius: 18px 18px 4px 18px; }
    .bubble-member { background: #d0e7ff; color: #3d5a80; align-self: flex-start; border-radius: 18px 18px 18px 4px; }
    .act-me { align-self: flex-end; color: #94a3b8; font-size: 12px; margin: 2px 8px 8px 0; font-weight: 400; }
    .act-member { align-self: flex-start; color: #94a3b8; font-size: 12px; margin: 2px 0 8px 8px; font-weight: 400; }
    .act-narrative { align-self: center; color: #cbd5e1; font-size: 11px; margin: 12px 0; text-align: center; width: 55%; }
    .jp-text { font-size: 11px; border-top: 1px solid rgba(124, 77, 58, 0.1); margin-top: 6px; padding-top: 4px; opacity: 0.85; font-family: 'Kiwi Maru', serif; }
    .chip { display: flex; align-items: center; justify-content: center; padding: 8px; border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .chip-active { background: var(--main-pink); color: white; }
    .chip-inactive { background: #f8f9fa; color: #adb5bd; }
    .editing-now { outline: 2px solid var(--main-pink); opacity: 0.7; transform: scale(0.98); }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--main-pink); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; }
    .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.7); display: flex; items-center; justify-content: center; z-index: 200; backdrop-blur: 2px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
    <div id="app">
        <div v-if="showAuthModal" class="fixed inset-0 bg-white/95 backdrop-blur-md z-[100] flex flex-col items-center justify-center p-8">
            <h1 class="text-4xl font-black text-[#ff9e97] mb-8 text-center">æ¨ã—æ´»ç´€éŒ„ğŸŒ¸</h1>
            <div class="w-full max-w-sm space-y-4">
                <input v-model="authEmail" type="email" placeholder="é›»å­éƒµä»¶" class="w-full bg-[#f8f9fa] rounded-2xl p-4 outline-none border border-gray-100">
                <input v-model="authPassword" type="password" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½)" class="w-full bg-[#f8f9fa] rounded-2xl p-4 outline-none border border-gray-100">
                <button @click="handleAuth" class="w-full btn-main py-4 font-bold shadow-lg active:scale-95 transition">
                    {{ isRegistering ? 'è¨»å†Šå¸³è™Ÿ' : 'ç™»å…¥ç³»çµ±' }}
                </button>
                <p @click="isRegistering = !isRegistering" class="text-center text-gray-400 text-xs cursor-pointer underline">
                    {{ isRegistering ? 'å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥' : 'æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š' }}
                </p>
            </div>
        </div>

        <div v-if="loading" class="loader-overlay"><div class="loader"></div></div>

        <div v-if="!showAuthModal" class="max-w-md mx-auto min-h-screen flex flex-col p-5 pb-28">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-black text-[#ff9e97]" @click="resetView">æ¨ã—æ´»ç´€éŒ„ğŸŒ¸</h1>
                    <p class="text-[10px] text-gray-300">{{ user?.email }} Â· <span @click="handleLogout" class="underline cursor-pointer">ç™»å‡º</span></p>
                </div>
                <div class="flex gap-4">
                    <i class="fas fa-chart-bar text-gray-200 text-lg cursor-pointer" @click="currentPage = 'stats'"></i>
                    <i class="fas fa-database text-gray-200 text-lg cursor-pointer" @click="currentPage = 'database'"></i>
                </div>
            </header>

            <section v-if="currentPage === 'stats'" class="space-y-6">
                <div class="soft-card p-5">
                    <h3 class="text-xs font-bold mb-4 text-gray-400 uppercase tracking-widest">æœˆæ¬¡è¦‹é¢é »ç‡</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="soft-card p-5">
                    <h3 class="text-xs font-bold mb-4 text-gray-400 uppercase tracking-widest">æˆå“¡åˆ†ä½ˆ (æšæ•¸)</h3>
                    <canvas id="memberPieChart"></canvas>
                </div>
            </section>

            <section v-if="currentPage === 'home'" class="space-y-6">
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 font-jp-serif">ãƒ¡ãƒ³ãƒãƒ¼</h3>
                    <div v-for="stat in sortedMemberStats" :key="stat.name" @click="filterByMember(stat.name)" class="soft-card p-5 flex items-center justify-between border-l-4 border-[#ffb7b2] active:scale-[0.98] transition cursor-pointer">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-2xl shadow-sm border-2 border-white" :style="getMemberStyle(stat.name)"></div>
                            <span class="font-bold text-base">{{ stat.name }}</span>
                        </div>
                        <div class="flex gap-4 text-right">
                            <div><div class="text-[10px] text-gray-400 font-bold">æ¬¡æ•¸</div><div class="text-xl font-black">{{ stat.count }}</div></div>
                            <div class="w-px h-8 bg-gray-100 self-end mb-1"></div>
                            <div><div class="text-[10px] text-gray-400 font-bold">æšæ•¸</div><div class="text-xl font-black text-[#ff9e97]">{{ stat.tickets }}</div></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 font-jp-serif">ã‚·ãƒ³ã‚°ãƒ«</h3>
                    <div class="grid grid-cols-1 gap-2">
                        <div v-for="s in db.singles" :key="s" @click="viewSingleHistory(s)" class="soft-card p-4 flex justify-between items-center active:scale-[0.98] transition cursor-pointer">
                            <div class="flex items-center gap-3"><i class="fas fa-compact-disc text-blue-100"></i><span class="text-sm font-bold">{{ s }}</span></div>
                            <i class="fas fa-chevron-right text-gray-200 text-xs"></i>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="currentPage === 'add'" class="space-y-4">
                <div class="soft-card p-5 space-y-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-2xl shadow-inner border-2 border-white" :style="getMemberStyle(form.member)"></div>
                        <div class="flex-grow space-y-2">
                            <select v-model="form.member" class="w-full bg-[#f8f9fa] rounded-xl p-3 text-sm font-bold outline-none">
                                <option value="">é¸æ“‡æˆå“¡</option>
                                <option v-for="m in db.members" :key="m.name" :value="m.name">{{ m.name }}</option>
                            </select>
                            <select v-model="form.single" class="w-full bg-[#f8f9fa] rounded-xl p-3 text-xs outline-none">
                                <option value="">é¸æ“‡å–®æ›²/æ´»å‹•</option>
                                <option v-for="s in db.singles" :key="s" :value="s">{{ s }}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <select v-model="form.location" class="w-full bg-[#f8f9fa] rounded-xl p-3 text-xs outline-none">
                                <option value="ç·šä¸Š">ğŸŒ ç·šä¸Š</option><option value="æ±äº¬">ğŸ—¼ æ±äº¬</option><option value="äº¬éƒ½">â›©ï¸ äº¬éƒ½</option><option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                            </select>
                            <input v-if="form.location === 'å…¶ä»–'" v-model="form.locationCustom" placeholder="è¼¸å…¥åœ°é»" class="w-full border-b border-pink-100 p-1 text-[10px] outline-none bg-transparent">
                        </div>
                        <div class="space-y-1">
                            <select v-model="form.type" class="w-full bg-[#f8f9fa] rounded-xl p-3 text-xs outline-none">
                                <option value="è¦‹é¢æœƒ">ğŸŒ¸ è¦‹é¢æœƒ</option><option value="ç°½åæœƒ">âœï¸ ç°½åæœƒ</option><option value="å…¶ä»–">ğŸ“Œ å…¶ä»–</option>
                            </select>
                            <input v-if="form.type === 'å…¶ä»–'" v-model="form.typeCustom" placeholder="è¼¸å…¥å½¢å¼" class="w-full border-b border-pink-100 p-1 text-[10px] outline-none bg-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" v-model="form.date" class="bg-[#f8f9fa] rounded-xl p-3 text-xs outline-none">
                        <input type="number" v-model="form.tickets" placeholder="æšæ•¸" class="bg-[#f8f9fa] rounded-xl p-3 text-sm font-bold text-center outline-none">
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <div v-for="n in 6" :key="n" @click="form.part = n" :class="['chip', form.part === n ? 'chip-active' : 'chip-inactive']">ç¬¬ {{ n }} éƒ¨</div>
                    </div>
                </div>

                <div class="soft-card p-5 h-[380px] flex flex-col overflow-hidden">
                    <div class="flex-grow overflow-y-auto flex flex-col p-1 space-y-1" id="chat-container">
                        <div v-for="(msg, i) in form.chat_logs" :key="i" class="flex flex-col relative group" @click="editMessage(i)">
                            <div v-if="['me','member'].includes(msg.role)" 
                                 :class="['chat-bubble shadow-sm', getBubbleClass(msg.role), editingMsgIndex === i ? 'editing-now' : '']">
                                <div class="font-medium tracking-wide">{{ msg.text }}</div>
                                <div v-if="msg.jp" class="jp-text">{{ msg.jp }}</div>
                                <div v-if="editingMsgIndex === i" class="absolute -top-2 -right-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px]" @click.stop="removeMessage(i)">
                                    <i class="fas fa-times"></i>
                                </div>
                            </div>
                            <div v-else :class="[getBubbleClass(msg.role), editingMsgIndex === i ? 'editing-now' : '']">
                                <span>{{ msg.role === 'narrative' ? msg.text : 'ï¼ˆ' + msg.text + 'ï¼‰' }}</span>
                                <div v-if="editingMsgIndex === i" class="absolute top-0 -right-4 text-red-400 text-xs" @click.stop="removeMessage(i)">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 space-y-2 bg-gray-50 p-3 rounded-2xl">
                        <div class="flex flex-wrap gap-1 justify-center mb-1">
                            <div v-for="r in roles" @click="msgRole = r.id" :class="['chip', msgRole === r.id ? 'chip-active' : 'chip-inactive']" style="padding: 2px 8px; font-size: 9px;">{{ r.name }}</div>
                        </div>
                        <input v-model="currentText" :placeholder="msgRole.includes('act') || msgRole === 'narrative' ? 'è¼¸å…¥å…§å®¹...' : 'å°è©±å…§å®¹ (ä¸­)...'" class="w-full bg-white rounded-lg p-2 text-sm outline-none">
                        <div v-if="!msgRole.includes('act') && msgRole !== 'narrative'" class="flex gap-2 items-center">
                            <input v-model="currentJP" placeholder="å°è©±å…§å®¹ (æ—¥)..." class="flex-grow bg-white rounded-lg p-2 text-[11px] outline-none">
                            <button @click="addMessage" class="w-10 h-10 bg-white rounded-xl text-[#ffb7b2] shadow-sm">
                                <i :class="editingMsgIndex !== null ? 'fas fa-check' : 'fas fa-paper-plane'"></i>
                            </button>
                        </div>
                        <button v-else @click="addMessage" class="w-full bg-white py-2 rounded-lg text-gray-400 text-xs shadow-sm">
                            {{ editingMsgIndex !== null ? 'ç¢ºèªä¿®æ”¹' : 'æ–°å¢å…§å®¹' }}
                        </button>

                        <button @click="endChat" class="w-full mt-2 py-2 bg-gray-100 rounded-lg text-gray-500 text-[10px] font-bold shadow-sm active:bg-gray-200 transition">
                            <i class="fas fa-flag-checkered mr-1"></i> çµæŸå°è©±
                        </button>
                        <p v-if="editingMsgIndex !== null" @click="cancelEdit" class="text-center text-[10px] text-gray-400 underline cursor-pointer">å–æ¶ˆç·¨è¼¯</p>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button @click="saveRecord" :disabled="syncing" class="flex-grow btn-main py-4 font-bold shadow-lg disabled:opacity-50">
                        <span v-if="syncing"><i class="fas fa-sync fa-spin mr-2"></i>åŒæ­¥ä¸­...</span>
                        <span v-else>{{ isEditing ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„' }}</span>
                    </button>
                    <button v-if="isEditing" @click="deleteFullRecord" class="w-14 bg-red-50 text-red-400 rounded-2xl active:bg-red-100 transition flex items-center justify-center shadow-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </section>

            <section v-if="currentPage === 'database'" class="space-y-6">
                <div class="soft-card p-6">
                    <h3 class="font-bold text-sm mb-4 font-jp-serif">æˆå“¡ç®¡ç† (é»æ“Šåœ“åœˆè¨­å®šé¡è‰²)</h3>
                    <div class="flex gap-2 mb-6">
                        <input v-model="newItem.member" placeholder="æˆå“¡å§“å" class="flex-grow bg-[#f8f9fa] rounded-xl p-3 text-xs outline-none">
                        <button @click="addToDb('members')" class="bg-[#ffb7b2] text-white px-5 rounded-xl text-xs font-bold">æ–°å¢</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div v-for="m in db.members" :key="m.name" class="bg-white p-3 rounded-2xl flex flex-col items-center relative shadow-sm border border-gray-50">
                            <div class="w-14 h-14 rounded-2xl mb-2 shadow-inner border-2 border-white cursor-pointer" 
                                 :style="getMemberStyle(m.name)"
                                 @click="editingMember = (editingMember === m ? null : m)">
                            </div>
                            <span class="text-xs font-bold">{{ m.name }}</span>
                            
                            <div v-if="editingMember === m" class="mt-2 flex gap-2 p-2 bg-gray-50 rounded-lg">
                                <input type="color" v-model="m.color1" @change="saveDb" class="w-6 h-6 border-none bg-transparent">
                                <input type="color" v-model="m.color2" @change="saveDb" class="w-6 h-6 border-none bg-transparent">
                                <i class="fas fa-check-circle text-green-400 self-center" @click="editingMember = null"></i>
                            </div>
                            
                            <i class="fas fa-times-circle absolute top-1 right-1 text-gray-200" @click="removeFromDb('members', m.name)"></i>
                        </div>
                    </div>
                </div>
                <div class="soft-card p-6">
                    <h3 class="font-bold text-sm mb-4 font-jp-serif">å–®æ›²ç®¡ç†</h3>
                    <div class="flex gap-2 mb-4">
                        <input v-model="newItem.single" placeholder="å–®æ›²åç¨±" class="flex-grow bg-[#f8f9fa] rounded-xl p-3 text-xs outline-none">
                        <button @click="addToDb('singles')" class="bg-[#adbcfd] text-white px-5 rounded-xl text-xs font-bold">æ–°å¢</button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="s in db.singles" :key="s" class="bg-white border border-gray-100 px-3 py-1.5 rounded-xl text-[10px] text-gray-400 flex items-center gap-2">
                            {{ s }} <i class="fas fa-times text-[8px]" @click="removeFromDb('singles', s)"></i>
                        </span>
                    </div>
                </div>
            </section>

            <section v-if="currentPage === 'history'" class="space-y-4">
                <div class="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm">
                    <span class="text-xs font-bold text-[#ffb7b2]">
                        {{ filterSingle ? 'æ´»å‹•ï¼š' + filterSingle : (filterMember ? 'æˆå“¡ï¼š' + filterMember : 'æ‰€æœ‰ç´€éŒ„') }}
                    </span>
                    <i class="fas fa-times-circle text-gray-200 cursor-pointer" @click="resetView"></i>
                </div>
                <div v-for="(group, date) in filteredGroupedHistory" :key="date" class="space-y-2">
                    <h3 class="text-xs font-bold text-gray-400 ml-2 font-jp-serif">{{ date }}</h3>
                    <div v-for="record in group.items" :key="record.id" @click="viewDetail(record)" class="soft-card p-4 flex items-center gap-4 active:scale-[0.98] transition cursor-pointer">
                        <div class="w-12 h-12 rounded-2xl shadow-sm border-2 border-white" :style="getMemberStyle(record.member)"></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm">{{ record.member }}</span>
                                <span class="text-[10px] font-black text-[#ffb7b2] bg-[#fff1e6] px-2 py-0.5 rounded-md"> ç¬¬ {{ record.part }} éƒ¨ </span>
                            </div>
                            <div class="text-[9px] text-gray-400 mt-1 uppercase">{{ record.single }} | {{ record.tickets }} æš | {{ record.location }}</div>
                        </div>
                    </div>
                </div>
            </section>

            <div v-if="selectedRecord" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end justify-center" @click.self="selectedRecord = null">
                <div class="bg-white w-full max-w-md rounded-t-[40px] p-8 max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
                    <div class="flex items-center gap-5 mb-6">
                        <div class="w-20 h-20 rounded-[24px] shadow-lg border-2 border-white" :style="getMemberStyle(selectedRecord.member)"></div>
                        <div class="space-y-1 flex-grow">
                            <div class="flex items-center justify-between">
                                <h3 class="font-black text-2xl text-[#5d514a] font-jp-serif">{{ selectedRecord.member }}</h3>
                                <i class="fas fa-edit text-gray-200 cursor-pointer text-sm" @click="editFullRecord(selectedRecord)"></i>
                            </div>
                            <p class="text-[10px] font-bold text-[#ffb7b2]">{{ selectedRecord.date }} | ç¬¬ {{ selectedRecord.part }} éƒ¨ | {{ selectedRecord.location }}</p>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex flex-col space-y-1 pb-10">
                        <div v-for="(msg, i) in selectedRecord.chat_logs" :key="i" class="flex flex-col">
                            <div v-if="['me','member'].includes(msg.role)" :class="['chat-bubble shadow-sm', getBubbleClass(msg.role)]">
                                <div class="font-medium tracking-wide">{{ msg.text }}</div>
                                <div v-if="msg.jp" class="jp-text">{{ msg.jp }}</div>
                            </div>
                            <div v-else :class="getBubbleClass(msg.role)">{{ msg.role === 'narrative' ? msg.text : 'ï¼ˆ' + msg.text + 'ï¼‰' }}</div>
                        </div>
                    </div>
                    <button @click="selectedRecord = null" class="w-full py-4 bg-[#f8f9fa] rounded-2xl text-gray-400 font-bold text-sm mt-4">é–‰ã˜ã‚‹</button>
                </div>
            </div>

            <nav class="fixed bottom-6 left-6 right-6 soft-card py-3 px-10 flex justify-between items-center z-40">
                <button @click="resetView" :class="currentPage === 'home' ? 'text-[#ffb7b2]' : 'text-gray-200'"><i class="fas fa-th-large text-lg"></i></button>
                <button @click="currentPage = 'add'" :class="currentPage === 'add' ? 'text-[#ffb7b2]' : 'text-gray-200'"><i class="fas fa-plus-circle text-2xl"></i></button>
                <button @click="currentPage = 'history'" :class="currentPage === 'history' ? 'text-[#ffb7b2]' : 'text-gray-200'"><i class="fas fa-book-open text-lg"></i></button>
            </nav>
        </div>
    </div>

    <script>
        // Firebase é…ç½® (ä¾†è‡ª Talk 3)
        const firebaseConfig = {
            apiKey: "AIzaSyAgsjhSx6LUBoXAhu0RO9f-0--jcxl91c8",
            authDomain: "migurirepo.firebaseapp.com",
            projectId: "migurirepo",
            storageBucket: "migurirepo.firebasestorage.app",
            messagingSenderId: "953319632032",
            appId: "1:953319632032:web:235e131606f8c845c16dc5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbStore = firebase.firestore();

        const { createApp } = Vue
        createApp({
            data() {
                return {
                    currentPage: 'home',
                    user: null, showAuthModal: true, isRegistering: false,
                    loading: true, syncing: false,
                    authEmail: '', authPassword: '',
                    msgRole: 'me', currentText: '', currentJP: '', editingMsgIndex: null, selectedRecord: null,
                    isEditing: false, editingId: null, filterMember: null, filterSingle: null, editingMember: null,
                    roles: [{ id: 'me', name: 'æˆ‘' }, { id: 'member', name: 'æˆå“¡' }, { id: 'me_act', name: 'æˆ‘çš„å‹•ä½œ' }, { id: 'mb_act', name: 'æˆå“¡çš„å‹•ä½œ' }, { id: 'narrative', name: 'å…¶ä»–' }],
                    db: { members: [], singles: [] },
                    newItem: { member: '', single: '' },
                    form: { 
                        date: new Date().toISOString().substr(0, 10), 
                        member: '', single: '', tickets: 1, part: 1, 
                        location: 'ç·šä¸Š', locationCustom: '', 
                        type: 'è¦‹é¢æœƒ', typeCustom: '',
                        chat_logs: [] 
                    },
                    history: [],
                    charts: { monthly: null, pie: null }
                }
            },
            mounted() {
                // ç›£è½ Auth ç‹€æ…‹
                auth.onAuthStateChanged(user => {
                    this.loading = false;
                    if (user) {
                        this.user = user;
                        this.showAuthModal = false;
                        this.fetchData();
                    } else {
                        this.showAuthModal = true;
                        this.user = null;
                    }
                });
            },
            watch: {
                currentPage(newVal) { if (newVal === 'stats') this.$nextTick(() => this.initCharts()); }
            },
            computed: {
                sortedMemberStats() {
                    const stats = this.history.reduce((acc, rec) => {
                        if (!acc[rec.member]) acc[rec.member] = { name: rec.member, tickets: 0, count: 0 };
                        acc[rec.member].tickets += Number(rec.tickets);
                        acc[rec.member].count += 1;
                        return acc;
                    }, {});
                    return Object.values(stats).sort((a, b) => b.tickets - a.tickets);
                },
                filteredGroupedHistory() {
                    let list = this.history;
                    if (this.filterMember) list = list.filter(h => h.member === this.filterMember);
                    if (this.filterSingle) list = list.filter(h => h.single === this.filterSingle);
                    const groups = {};
                    [...list].sort((a,b) => b.date.localeCompare(a.date) || a.part - b.part).forEach(item => {
                        if (!groups[item.date]) groups[item.date] = { items: [] };
                        groups[item.date].items.push(item);
                    });
                    return groups;
                }
            },
            methods: {
                // Firebase Auth é‚è¼¯
                async handleAuth() {
                    if (!this.authEmail || !this.authPassword) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
                    this.loading = true;
                    try {
                        if (this.isRegistering) {
                            await auth.createUserWithEmailAndPassword(this.authEmail, this.authPassword);
                        } else {
                            await auth.signInWithEmailAndPassword(this.authEmail, this.authPassword);
                        }
                    } catch (e) {
                        alert(e.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async handleLogout() {
                    if (confirm("ç¢ºå®šç™»å‡ºå—ï¼Ÿ")) await auth.signOut();
                },

                // Firebase Firestore è®€å–é‚è¼¯
                async fetchData() {
                    if (!this.user) return;
                    this.loading = true;
                    try {
                        // è®€å–è¨­å®š
                        const dbDoc = await dbStore.collection('users').doc(this.user.uid).collection('settings').doc('db').get();
                        if (dbDoc.exists) this.db = dbDoc.data();

                        // è®€å–æ­·å²ç´€éŒ„
                        const snapshot = await dbStore.collection('users').doc(this.user.uid).collection('history').orderBy('date', 'desc').get();
                        this.history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) {
                        console.error(e);
                    } finally {
                        this.loading = false;
                    }
                },

                getMemberStyle(name) {
                    const m = this.db.members.find(m => m.name === name);
                    if (!m) return { background: '#f3f4f6' };
                    return { background: `linear-gradient(135deg, ${m.color1 || '#ffb7b2'}, ${m.color2 || '#d0e7ff'})` };
                },

                addMessage() {
                    if (!this.currentText.trim() && !this.currentJP.trim()) return;
                    const msg = { role: this.msgRole, text: this.currentText, jp: this.currentJP };
                    if (this.editingMsgIndex !== null) this.form.chat_logs[this.editingMsgIndex] = msg;
                    else this.form.chat_logs.push(msg);
                    this.cancelEdit();
                    this.$nextTick(() => {
                        const container = document.getElementById('chat-container');
                        if (container) container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                    });
                },
                endChat() {
                    this.form.chat_logs.push({ role: 'narrative', text: 'âŠ¹ â”€ å°è©±çµæŸ â”€ âŠ¹', jp: '' });
                    this.saveRecord();
                },
                editMessage(i) {
                    const m = this.form.chat_logs[i];
                    this.msgRole = m.role; this.currentText = m.text; this.currentJP = m.jp || '';
                    this.editingMsgIndex = i;
                },
                removeMessage(i) { this.form.chat_logs.splice(i, 1); this.editingMsgIndex = null; },
                cancelEdit() { this.currentText = ''; this.currentJP = ''; this.editingMsgIndex = null; },
                
                addToDb(type) {
                    if (type === 'members' && this.newItem.member) {
                        this.db.members.push({ name: this.newItem.member, color1: '#ffb7b2', color2: '#d0e7ff' });
                    } else if (type === 'singles' && this.newItem.single) {
                        if (!this.db.singles.includes(this.newItem.single)) this.db.singles.push(this.newItem.single);
                    }
                    this.saveDb(); this.newItem = { member: '', single: '' };
                },
                removeFromDb(type, key) {
                    if (type === 'members') this.db.members = this.db.members.filter(m => m.name !== key);
                    else if (type === 'singles') this.db.singles = this.db.singles.filter(s => s !== key);
                    this.saveDb();
                },
                async saveDb() { 
                    await dbStore.collection('users').doc(this.user.uid).collection('settings').doc('db').set(this.db);
                },

                async saveRecord() {
                    if (!this.form.member) return alert('è«‹é¸æ“‡æˆå“¡ï¼');
                    this.syncing = true;
                    try {
                        const finalLoc = this.form.location === 'å…¶ä»–' ? this.form.locationCustom : this.form.location;
                        const finalType = this.form.type === 'å…¶ä»–' ? this.form.typeCustom : this.form.type;
                        const record = { ...this.form, location: finalLoc, type: finalType };
                        
                        if (this.isEditing) {
                            await dbStore.collection('users').doc(this.user.uid).collection('history').doc(this.editingId).update(record);
                        } else {
                            await dbStore.collection('users').doc(this.user.uid).collection('history').add(record);
                        }
                        await this.fetchData();
                        this.resetForm();
                        this.currentPage = 'history';
                    } catch (e) {
                        alert("å„²å­˜å¤±æ•—");
                    } finally {
                        this.syncing = false;
                    }
                },
                async deleteFullRecord() {
                    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™æ•´ç­†ç´€éŒ„å—ï¼Ÿ')) return;
                    this.syncing = true;
                    try {
                        await dbStore.collection('users').doc(this.user.uid).collection('history').doc(this.editingId).delete();
                        await this.fetchData();
                        this.resetForm();
                        this.currentPage = 'history';
                    } catch (e) {
                        alert("åˆªé™¤å¤±æ•—");
                    } finally {
                        this.syncing = false;
                    }
                },
                editFullRecord(r) {
                    this.form = JSON.parse(JSON.stringify(r));
                    if (!['ç·šä¸Š', 'æ±äº¬', 'äº¬éƒ½'].includes(this.form.location)) { this.form.locationCustom = this.form.location; this.form.location = 'å…¶ä»–'; }
                    if (!['è¦‹é¢æœƒ', 'ç°½åæœƒ'].includes(this.form.type)) { this.form.typeCustom = this.form.type; this.form.type = 'å…¶ä»–'; }
                    this.isEditing = true; this.editingId = r.id;
                    this.currentPage = 'add'; this.selectedRecord = null;
                },
                resetForm() {
                    this.form = { date: new Date().toISOString().substr(0, 10), member: '', single: '', tickets: 1, part: 1, location: 'ç·šä¸Š', locationCustom: '', type: 'è¦‹é¢æœƒ', typeCustom: '', chat_logs: [] };
                    this.isEditing = false; this.editingId = null;
                },
                resetView() { this.filterMember = this.filterSingle = null; this.currentPage = 'home'; },
                viewDetail(r) { this.selectedRecord = r; },
                filterByMember(n) { this.filterMember = n; this.filterSingle = null; this.currentPage = 'history'; },
                viewSingleHistory(s) { this.filterSingle = s; this.filterMember = null; this.currentPage = 'history'; },
                getBubbleClass(role) {
                    return { 'bubble-me': role === 'me', 'bubble-member': role === 'member', 'act-me': role === 'me_act', 'act-member': role === 'mb_act', 'act-narrative': role === 'narrative' };
                },
                initCharts() {
                    const singles = this.db.singles; 
                    const memberDatasets = {};
                    this.db.members.forEach(m => {
                        memberDatasets[m.name] = {
                            label: m.name,
                            data: new Array(singles.length).fill(0),
                            borderColor: m.color1 || '#ffb7b2',
                            backgroundColor: m.color1 || '#ffb7b2',
                            tension: 0.3,
                            fill: false
                        };
                    });

                    this.history.forEach(h => {
                        const sIdx = singles.indexOf(h.single);
                        if (sIdx !== -1 && memberDatasets[h.member]) {
                            memberDatasets[h.member].data[sIdx] += Number(h.tickets || 0);
                        }
                    });

                    const sortedStats = [...this.sortedMemberStats];
                    const barLabels = sortedStats.map(s => s.name);
                    const barData = sortedStats.map(s => s.tickets);
                    const barColors = sortedStats.map(s => {
                        const m = this.db.members.find(mem => mem.name === s.name);
                        return m ? m.color1 : '#ffb7b2';
                    });

                    if (this.charts.monthly) this.charts.monthly.destroy();
                    const ctxM = document.getElementById('monthlyChart')?.getContext('2d');
                    if (ctxM) {
                        this.charts.monthly = new Chart(ctxM, {
                            type: 'line',
                            data: {
                                labels: singles,
                                datasets: Object.values(memberDatasets)
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { display: true, labels: { boxWidth: 12, font: { size: 10 } } } },
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                    }

                    if (this.charts.pie) this.charts.pie.destroy();
                    const ctxP = document.getElementById('memberPieChart')?.getContext('2d');
                    if (ctxP) {
                        this.charts.pie = new Chart(ctxP, {
                            type: 'bar',
                            data: {
                                labels: barLabels,
                                datasets: [{
                                    label: 'ç´¯ç©æšæ•¸',
                                    data: barData,
                                    backgroundColor: barColors,
                                    borderRadius: 8,
                                }]
                            },
                            options: {
                                indexAxis: 'y', 
                                responsive: true,
                                plugins: { legend: { display: false } },
                                scales: { 
                                    x: { beginAtZero: true },
                                    y: { grid: { display: false } }
                                }
                            }
                        });
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>

